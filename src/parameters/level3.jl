include("level3/prime.jl")
include("level3/constants.jl")

include("../quaternion/order.jl")
include("../quaternion/cornacchia.jl")
include("../quaternion/ideal.jl")
include("../quaternion/klpt.jl")

include("../rii/quat_action.jl")
include("../rii/rii.jl")
include("../double_path/double_path.jl")
include("../utilities/for_compression.jl")
include("../sqisign2d_push/sqisign2d_push.jl")

const StrategiesDim2 = Dict(
    ExponentOfTwo - i => compute_strategy(ExponentOfTwo-2 - i, 2, 1)
    for i in 0:ExponentOfTwo-2
)
const StrategiesDim1Two = Dict(
    ExponentOfTwo => compute_strategy(div(ExponentOfTwo,2) - 1, 1, 1),
)

const StrategiesDim1Three = Dict(
    ExponentOfThree => compute_strategy(ExponentOfThree - 1, 1, 1),
)

function make_E0_data()
    _, T = polynomial_ring(GF(p), "T")
    Fp2, Fp2_i = finite_field(T^2 + 1, "i")

    A0 = Fp2(0)

    # constants from precompute/level2torsion.txt
    P2e = Point(68931441596356569108744527820985106314888689246142054260925853502696615219551945976361081554625894858083196236600520*Fp2_i + 128994005595630005304526077272403404790699959761041769003451778019000558006281896072998924219749248808746788797357169, 58581206302663579314029514757620716230947080487903555993129195106413398696192520524727144182759599570799258154124964*Fp2_i + 76763439248177128523117643478396782160821829976630764660569766031349940838315908533654623464234430625687087610108664)
    Q2e = Point(66428756068850820705028445841803445867521457638502493020821658388101092876390868863973571146350764249981156195167031*Fp2_i + 6366192069577384509246896390385147391710187123602778278295733871797150089660918767335728481227410299317563634410382, 76763439248177128523117643478396782160821829976630764660569766031349940838315908533654623464234430625687087610108664*Fp2_i + 76778991362543810499743458905167835951463066396740991288618316784384309399750294315607508518217059537265094277642587)
    M_i_2e = [0 25108406941546723055343157692830665664409421777856138051583; 1 0]
    M_ij_2e = [23196535666535512643935866789076153076423329450862888406222 18740627734110276796763658200337567077723825872935513586003; 18740627734110276796763658200337567077723825872935513586004 1911871275011210411407290903754512587986092326993249645362]
    M_1k_2e = [6367779207436446258579499492493098586685595904920624465581 23196535666535512643935866789076153076423329450862888406222; 23196535666535512643935866789076153076423329450862888406222 18740627734110276796763658200337567077723825872935513586004]
    P3e = Point(78225040506583300765507230958757080099017001346084453137168033174726737624165129671179686625919755795953945738330958*Fp2_i + 67272689322801328630435859634724250273643355061095423543956082926033269848543256602029959453382005623069785864443763, 84766055010731070458574399135737901882305871519365224634799184146454572700695764834251468704526010636825670984746444*Fp2_i + 40969691037450019326428455259438257042782323246683594782752651366811066003535917982519039516204950943054521782786281)
    Q3e = Point(103676029593407836568495123841744273445661740962878341327782965682432798670212426388509151352047639065917205975511810*Fp2_i + 73352687320162648896163002644343249522461749549629330999639728121153518644488915300721824337360041971408081734804487, 119606149451831651171632117590632961555057687754250362139901372426810478379464277658890734975858194850405113881432715*Fp2_i + 81239520554231758207576091115980178837875640490596483175193235387474707824539344237876367013562900229746528486898994)
    M_i_3e = [5107718341942846040037836412042633635503460229512311125054 1912659798562998773779368874135113631495044281483879452388; 4042593935813376538839757316241541803787495181374711884307 283312557800447591201703076486181483690966653101242194149]
    M_ij_3e = [317892270380303920293249022701601123423760772611942745766 3970576180982947992289840355322086377110613382920231420717; 4266190834166088573067060181549293367936183415435077483399 5073138629362989710946290465827213995770666110001610573437]
    M_1k_3e = [1476588803235773553227285859556180026435136013328168817022 3160700555964898249970392338318829442156249631345583987201; 793189600457816780471293218194385467289254408312242650652 3914442096507520078012253628972635092759290869285384502182]
    M44inv_chall = [3914442096507520078012253628972635092759290869285384502182 2230330343778395381269147150209985677038177251267969332002 4597841299285476850768246270334429651905172474301310668551 1476588803235773553227285859556180026435136013328168817022; 5073138629362989710946290465827213995770666110001610573437 1420454718760345638949699133206728742083813499693321898486 1124840065577205058172479306979521751258243467178475835804 317892270380303920293249022701601123423760772611942745766; 919097098561055431788201121889383730538488198325127685681 637461663659603579560772347980244003531755601743030069843 4489787732518800607294363046857044932084871649495443082491 4471933801182238199451338366639431388655938684288425633522; 2953177606471547106454571719112360052870272026656337634043 930370212186502868701245188108843765118072380077614655199 1586379200915633560942586436388770934578508816624485301304 2437853293271746524784967769416455066324154855957215685160]

    a24_0 = A_to_a24(A0)

    P0 = add(P2e, P3e, Proj1(A0))
    Q0 = add(Q2e, Q3e, Proj1(A0))
    xP0 = Proj1(P0.X, P0.Z)
    xQ0 = Proj1(Q0.X, Q0.Z)
    PQ0 = add(P0, -Q0, Proj1(A0))
    xPQ0 = Proj1(PQ0.X, PQ0.Z)
    basis2e3e = BasisData(xP0, xQ0, xPQ0)

    xP2e = Proj1(P2e.X, P2e.Z)
    xQ2e = Proj1(Q2e.X, Q2e.Z)
    PQ2e = add(P2e, -Q2e, Proj1(A0))
    xPQ2e = Proj1(PQ2e.X, PQ2e.Z)
    basis2e = BasisData(xP2e, xQ2e, xPQ2e)

    xP3e = Proj1(P3e.X, P3e.Z)
    xQ3e = Proj1(Q3e.X, Q3e.Z)
    PQ3e = add(P3e, -Q3e, Proj1(A0))
    xPQ3e = Proj1(PQ3e.X, PQ3e.Z)
    basis3e = BasisData(xP3e, xQ3e, xPQ3e)

    Matrices_2e = [M_i_2e, M_ij_2e, M_1k_2e]
    Matrices_3e = [M_i_3e, M_ij_3e, M_1k_3e]

    return Fp2, E0Data(A0, a24_0, basis2e, basis3e, Matrices_2e, Matrices_3e, M44inv_chall)
end

# Fp2 and values in Fp2
function make_precomputed_values()
    Fp2, E0 = make_E0_data()

    return GlobalData(Fp2, E0)
end