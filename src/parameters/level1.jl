include("level1/prime.jl")
include("level1/constants.jl")

include("../quaternion/order.jl")
include("../quaternion/cornacchia.jl")
include("../quaternion/ideal.jl")
include("../quaternion/klpt.jl")

include("global_data.jl")

include("../rii/quat_action.jl")
include("../rii/rii.jl")
include("../double_path/double_path.jl")
include("../utilities/for_compression.jl")
include("../sqisign2d_push/sqisign2d_push.jl")

const StrategiesDim2 = Dict(
    ExponentOfTwo - i => compute_strategy(ExponentOfTwo-2 - i, 2, 1)
    for i in 0:ExponentOfTwo-2
)
const StrategiesDim1Two = Dict(
    ExponentOfTwo => compute_strategy(div(ExponentOfTwo,2) - 1, 1, 1),
)

const StrategiesDim1Three = Dict(
    ExponentOfThree => compute_strategy(ExponentOfThree - 1, 1, 1),
)

function make_E0_data()
    _, T = polynomial_ring(GF(p), "T")
    Fp2, Fp2_i = finite_field(T^2 + 1, "i")

    A0 = Fp2(0)

    # constants from precompute/level1torsion.txt
    P2e = Point(1531149781711917380367060239285238186300487199836080014663337348616798943170633*Fp2_i + 3110382937731504869536565537496875767584981042621809716732346748331993571065399, 4039804177053620030988880655691742858697099202524887514558580934455406914776902*Fp2_i + 3550721969574630064547234599815927349493838338141797270062684573900349635887548)
    Q2e = Point(4102084910679891093702283854639291337424569102586570711291205562199617354739638*Fp2_i + 2522851754660303604532778556427653756140075259800841009222196162484422726844872, 3550721969574630064547234599815927349493838338141797270062684573900349635887548*Fp2_i + 1593430515338188443080463438232786665027957099897763211395961976361009383133369)
    M_i_2e = [0 5444517870735015415413993718908291383295; 1 0]
    M_ij_2e = [4324312174203190724284295886362054813240 3334345937367886101996163442172158886848; 3334345937367886101996163442172158886849 1120205696531824691129697832546236570056]
    M_1k_2e = [2110171933367129313417830276736132496448 4324312174203190724284295886362054813240; 4324312174203190724284295886362054813240 3334345937367886101996163442172158886849]
    P3e = Point(2006982394376954054746282658989847061026521116048221434820315293094959912872476*Fp2_i + 108938614186280581715727671435891067310712878773562090392725294703051835860519, 3045087778386466394981949753874123890935402090926658244678695787342931849886897*Fp2_i + 4135746303091571843813910553603603847471653302956569747147568722468001408561092)
    Q3e = Point(3580470049332746741947130760416220554306664994686110901933585473854957312084444*Fp2_i + 4886745583818571840949688587415249425980637476684590448621209502512499302639836, 1058559647497099802500296356201468133140232567455848043656029939521670767143125*Fp2_i + 4833427449357231697459747797455252796818456485771877926638641051299787066793395)
    M_i_3e = [91191506070529126425020339914589708954 21744219888908283138058115059088881229; 29621950572876406765434768461894207096 56617323343816796891062870291793588647]
    M_ij_3e = [56165343702337901204160687363596405747 138446665261109147178718883603964753340; 113916734810988923526211326291292620635 91643485712008022111922522842786891854]
    M_1k_3e = [4554926750764503528794585725061784153 4672809189945585326802823747777729600; 12706980453292678961168823337516420164 143253902663581419787288624481321513449]
    M44inv_chall = [143253902663581419787288624481321513449 143136020224400337989280386458605568001 135101848961053244354914386868866877437 4554926750764503528794585725061784153; 91643485712008022111922522842786891854 9362164153236776137364326602418544261 33892094603356999789871883915090676966 56165343702337901204160687363596405747; 21139181334146675983301034812603102540 107340281218964087903296441942457327850 50402689634755516970904673914307736573 126669648080199247332782175393780195061; 9109853501529007057589171450123568305 9345618379891170653605647495555459200 25413960906585357922337646675032840328 138698975912816916258494038756259729296]

    a24_0 = A_to_a24(A0)

    P0 = add(P2e, P3e, Proj1(A0))
    Q0 = add(Q2e, Q3e, Proj1(A0))
    xP0 = Proj1(P0.X, P0.Z)
    xQ0 = Proj1(Q0.X, Q0.Z)
    PQ0 = add(P0, -Q0, Proj1(A0))
    xPQ0 = Proj1(PQ0.X, PQ0.Z)
    basis2e3e = BasisData(xP0, xQ0, xPQ0)

    xP2e = Proj1(P2e.X, P2e.Z)
    xQ2e = Proj1(Q2e.X, Q2e.Z)
    PQ2e = add(P2e, -Q2e, Proj1(A0))
    xPQ2e = Proj1(PQ2e.X, PQ2e.Z)
    basis2e = BasisData(xP2e, xQ2e, xPQ2e)

    xP3e = Proj1(P3e.X, P3e.Z)
    xQ3e = Proj1(Q3e.X, Q3e.Z)
    PQ3e = add(P3e, -Q3e, Proj1(A0))
    xPQ3e = Proj1(PQ3e.X, PQ3e.Z)
    basis3e = BasisData(xP3e, xQ3e, xPQ3e)

    Matrices_2e = [M_i_2e, M_ij_2e, M_1k_2e]
    Matrices_3e = [M_i_3e, M_ij_3e, M_1k_3e]

    return Fp2, E0Data(A0, a24_0, basis2e, basis3e, Matrices_2e, Matrices_3e, M44inv_chall)
end

# Fp2 and values in Fp2
function make_precomputed_values()
    Fp2, E0 = make_E0_data()

    return GlobalData(Fp2, E0)
end